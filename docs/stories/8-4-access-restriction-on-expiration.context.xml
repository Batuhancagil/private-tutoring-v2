<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>8-4</storyId>
    <title>Access Restriction on Expiration</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/8-4-access-restriction-on-expiration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system</asA>
    <iWant>to restrict teacher access when subscription expires</iWant>
    <soThat>only active subscribers can use the platform</soThat>
    <tasks>
      <task>Create subscription-helpers.ts with isSubscriptionActive() function</task>
      <task>Check if subscription is active: current date between startDate and endDate</task>
      <task>Update authentication middleware to check subscription status</task>
      <task>Deny access and redirect to expiration page if expired</task>
      <task>Create expiration page (app/expired/page.tsx)</task>
      <task>Handle subscription expiration during active session (logout and redirect)</task>
      <task>Skip subscription check for Superadmin (always allowed)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <given>a teacher's subscription has expired</given>
      <when>they try to log in</when>
      <then>access is denied</then>
      <and>they see an expiration message</and>
      <and>Superadmin can extend the subscription</and>
    </criterion>
    <criterion id="AC2">
      <given>a teacher's subscription is active</given>
      <when>they try to log in</when>
      <then>access is granted</then>
      <and>they can use all features normally</and>
    </criterion>
    <criterion id="AC3">
      <given>a teacher's subscription expires while they are logged in</given>
      <when>they make a request</when>
      <then>access is denied</then>
      <and>they are logged out</and>
      <and>they see an expiration message</and>
    </criterion>
    <criterion id="AC4">
      <given>Superadmin extends an expired subscription</given>
      <when>teacher tries to log in again</when>
      <then>access is granted</then>
      <and>they can use all features normally</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 8: Subscription Management - Story 8.4</section>
        <snippet>As a system, I want to restrict teacher access when subscription expires, So that only active subscribers can use the platform. Subscription status check, access restriction middleware, expiration page.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-009: Subscription Management</section>
        <snippet>FR-009.4: The system shall restrict teacher access when subscription expires. Teachers with expired subscriptions cannot access the platform until subscription is renewed.</snippet>
      </doc>
      <doc>
        <path>docs/stories/8-1-subscription-crud-operations.md</path>
        <title>Story 8.1: Subscription CRUD Operations</title>
        <section>Learnings</section>
        <snippet>Subscription model exists. Subscription status calculation patterns established. Subscription API endpoints established.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware</symbol>
        <lines>1-100</lines>
        <reason>Next.js middleware for authentication. Update to check subscription status after authentication for teachers. Deny access if expired.</reason>
      </artifact>
      <artifact>
        <path>lib/auth-helpers.ts</path>
        <kind>utility</kind>
        <symbol>getCurrentUser, requireAuth</symbol>
        <lines>1-100</lines>
        <reason>Authentication helper functions. May need to extend to check subscription status for teachers.</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>database schema</kind>
        <symbol>Subscription</symbol>
        <lines>142-153</lines>
        <reason>Subscription model with startDate and endDate fields. Use to check if subscription is active (current date between startDate and endDate).</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="next" version="^14.2.0" />
        <package name="react" version="^18.3.0" />
        <package name="react-dom" version="^18.3.0" />
        <package name="@prisma/client" version="^5.19.0" />
        <package name="prisma" version="^5.19.0" />
        <package name="zod" version="^3.23.8" />
        <package name="typescript" version="^5.5.0" />
        <package name="date-fns" version="^4.1.0" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Subscription check: Check if subscription is active (current date between startDate and endDate) for teachers</constraint>
    <constraint>Access restriction: Deny access and redirect to expiration page if subscription expired</constraint>
    <constraint>Superadmin bypass: Skip subscription check for Superadmin (always allowed)</constraint>
    <constraint>Session expiration: Handle subscription expiration during active session (logout and redirect)</constraint>
    <constraint>Performance: Subscription check should be fast, consider caching subscription status</constraint>
    <constraint>Error handling: Handle edge cases: no subscription, expired subscription, upcoming subscription</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>isSubscriptionActive()</name>
      <kind>function</kind>
      <signature>async function isSubscriptionActive(teacherId: string): Promise&lt;boolean&gt;
Input: teacherId (string)
Output: boolean (true if active, false if expired or no subscription)
Checks if teacher's subscription is active (current date between startDate and endDate)</signature>
      <path>lib/subscription-helpers.ts</path>
    </interface>
    <interface>
      <name>GET /expired</name>
      <kind>page route</kind>
      <signature>Page displays expiration message and contact information for subscription renewal.</signature>
      <path>app/expired/page.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing approach: Integration tests for middleware subscription check, authentication flow tests, expiration page tests.
      Focus on access restriction correctness, subscription status checking, and user experience.
      Test edge cases: no subscription, expired subscription, active subscription, subscription expires during session, Superadmin bypass.
      Manual testing for login flow and access restriction.
    </standards>
    <locations>
      Integration tests: Test middleware and authentication flow via browser dev tools
      Component tests: Test expiration page rendering
      No formal test framework currently configured - focus on manual testing and code review
    </locations>
    <ideas>
      <test id="AC1">
        <description>Test expired subscription login</description>
        <steps>1. Try to login as teacher with expired subscription. 2. Verify access denied. 3. Verify expiration message displays. 4. Verify Superadmin can extend subscription.</steps>
      </test>
      <test id="AC2">
        <description>Test active subscription login</description>
        <steps>1. Login as teacher with active subscription. 2. Verify access granted. 3. Verify can use all features normally.</steps>
      </test>
      <test id="AC3">
        <description>Test subscription expiration during session</description>
        <steps>1. Login as teacher with active subscription. 2. Expire subscription (update endDate). 3. Make a request. 4. Verify access denied. 5. Verify logged out. 6. Verify expiration message displays.</steps>
      </test>
      <test id="AC4">
        <description>Test subscription extension</description>
        <steps>1. Extend expired subscription as Superadmin. 2. Teacher tries to login again. 3. Verify access granted. 4. Verify can use all features normally.</steps>
      </test>
    </ideas>
  </tests>
</story-context>

