<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>8-1</storyId>
    <title>Subscription CRUD Operations</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/8-1-subscription-crud-operations.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Superadmin</asA>
    <iWant>to create and manage teacher subscriptions</iWant>
    <soThat>I can control access to the platform</soThat>
    <tasks>
      <task>Check if Subscription model exists in schema, create if needed</task>
      <task>Create subscription API endpoints (app/api/admin/subscriptions/route.ts and [id]/route.ts)</task>
      <task>Implement GET (list all), POST (create), GET [id] (get one), PUT [id] (update), DELETE [id] (delete)</task>
      <task>Create subscription list page (app/admin/subscriptions/page.tsx)</task>
      <task>Create SubscriptionForm component (components/admin/SubscriptionForm.tsx)</task>
      <task>Implement subscription status calculation (active, expired, upcoming)</task>
      <task>Add date validation (end date must be after start date)</task>
      <task>Add subscription management UI (create, edit, delete buttons)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <given>I am logged in as Superadmin</given>
      <when>I manage subscriptions</when>
      <then>I can: Create new subscriptions, Set start date and end date, Edit subscription details, Delete subscriptions, View all subscriptions</then>
    </criterion>
    <criterion id="AC2">
      <given>I am creating a new subscription</given>
      <when>I fill out the subscription form</when>
      <then>I can: Select a teacher from the list, Set subscription start date, Set subscription end date, Validate that end date is after start date, Save the subscription</then>
    </criterion>
    <criterion id="AC3">
      <given>I am viewing subscriptions</given>
      <when>I see the subscription list</when>
      <then>I see: All subscriptions in a table/list, Teacher name for each subscription, Start date and end date, Subscription status (active, expired, upcoming), Ability to edit or delete each subscription</then>
    </criterion>
    <criterion id="AC4">
      <given>I am editing a subscription</given>
      <when>I update subscription details</when>
      <then>changes are saved</then>
      <and>subscription status updates if dates change</and>
      <and>teacher access is updated accordingly</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 8: Subscription Management - Story 8.1</section>
        <snippet>As a Superadmin, I want to create and manage teacher subscriptions, So that I can control access to the platform. Subscription data model, CRUD operations, subscription-teacher relationship.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-009: Subscription Management</section>
        <snippet>FR-009.1: Superadmin shall manage teacher subscriptions. Create, edit, delete subscriptions with start and end dates. Track subscription status (active, expired, upcoming).</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-1-superadmin-creates-teacher-accounts.md</path>
        <title>Story 2.1: Superadmin Creates Teacher Accounts</title>
        <section>Learnings</section>
        <snippet>Admin API pattern established. Admin pages pattern established. Form components pattern established. Superadmin authorization helper exists.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>database schema</kind>
        <symbol>Subscription</symbol>
        <lines>142-153</lines>
        <reason>Subscription model already exists with teacherId, startDate, endDate fields. Use for subscription CRUD operations.</reason>
      </artifact>
      <artifact>
        <path>app/api/admin/teachers/route.ts</path>
        <kind>API route</kind>
        <symbol>GETHandler, POSTHandler</symbol>
        <lines>1-200</lines>
        <reason>Example admin API pattern to follow: uses withRole('SUPERADMIN') helper, Zod validation, error logging, performance tracking.</reason>
      </artifact>
      <artifact>
        <path>components/admin/TeacherForm.tsx</path>
        <kind>component</kind>
        <symbol>TeacherForm</symbol>
        <lines>1-150</lines>
        <reason>Example admin form component pattern to follow. Create SubscriptionForm following similar patterns.</reason>
      </artifact>
      <artifact>
        <path>app/admin/teachers/page.tsx</path>
        <kind>page</kind>
        <symbol>TeachersPage</symbol>
        <lines>1-100</lines>
        <reason>Example admin page pattern to follow. Create subscriptions page following similar structure.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="next" version="^14.2.0" />
        <package name="react" version="^18.3.0" />
        <package name="react-dom" version="^18.3.0" />
        <package name="@prisma/client" version="^5.19.0" />
        <package name="prisma" version="^5.19.0" />
        <package name="zod" version="^3.23.8" />
        <package name="typescript" version="^5.5.0" />
        <package name="date-fns" version="^4.1.0" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Global scope: Subscriptions are global (not tenant-scoped) - Superadmin manages all subscriptions</constraint>
    <constraint>API authorization: Use withRole('SUPERADMIN') helper to ensure only superadmins can manage subscriptions</constraint>
    <constraint>Date validation: End date must be after start date - validate in both API and form</constraint>
    <constraint>Status calculation: Active (current date between startDate and endDate), Expired (current date > endDate), Upcoming (current date < startDate)</constraint>
    <constraint>Component pattern: Follow existing component patterns from components/admin/ - use TypeScript, Tailwind CSS, proper prop types</constraint>
    <constraint>API pattern: Follow existing pattern from app/api/admin/teachers/route.ts - use withRole() helper, Zod validation, error logging</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/admin/subscriptions</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/admin/subscriptions
Response (200): {
  subscriptions: [
    {
      id: string,
      teacherId: string,
      teacherName: string,
      startDate: string,
      endDate: string,
      status: 'active' | 'expired' | 'upcoming'
    }
  ]
}
Response (403): { error: "Access denied" }</signature>
      <path>app/api/admin/subscriptions/route.ts</path>
    </interface>
    <interface>
      <name>POST /api/admin/subscriptions</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/admin/subscriptions
Body: { teacherId: string, startDate: string, endDate: string }
Response (200): { success: boolean, data: Subscription }
Response (400): { error: "Validation error", details: [...] }
Response (403): { error: "Access denied" }</signature>
      <path>app/api/admin/subscriptions/route.ts</path>
    </interface>
    <interface>
      <name>PUT /api/admin/subscriptions/:id</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/admin/subscriptions/:id
Body: { startDate?: string, endDate?: string }
Response (200): { success: boolean, data: Subscription }
Response (404): { error: "Subscription not found" }
Response (403): { error: "Access denied" }</signature>
      <path>app/api/admin/subscriptions/[id]/route.ts</path>
    </interface>
    <interface>
      <name>DELETE /api/admin/subscriptions/:id</name>
      <kind>REST endpoint</kind>
      <signature>DELETE /api/admin/subscriptions/:id
Response (200): { success: boolean }
Response (404): { error: "Subscription not found" }
Response (403): { error: "Access denied" }</signature>
      <path>app/api/admin/subscriptions/[id]/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing approach: Integration tests for API endpoints, component tests for form validation and CRUD operations, authorization tests.
      Focus on CRUD operations correctness, date validation, status calculation, and authorization.
      Test edge cases: invalid dates, end date before start date, subscription status transitions, authorization.
      Manual testing for form interactions and CRUD operations.
    </standards>
    <locations>
      Integration tests: Test API endpoints via browser dev tools Network tab or Postman
      Component tests: Test SubscriptionForm component validation and CRUD operations
      No formal test framework currently configured - focus on manual testing and code review
    </locations>
    <ideas>
      <test id="AC1">
        <description>Test CRUD operations</description>
        <steps>1. Create new subscription. 2. View subscription list. 3. Edit subscription. 4. Delete subscription. 5. Verify all operations work correctly.</steps>
      </test>
      <test id="AC2">
        <description>Test subscription form</description>
        <steps>1. Fill subscription form with valid data. 2. Verify can select teacher. 3. Verify can set start and end dates. 4. Verify end date validation (must be after start date). 5. Verify subscription saves.</steps>
      </test>
      <test id="AC3">
        <description>Test subscription list</description>
        <steps>1. View subscription list. 2. Verify displays all subscriptions. 3. Verify shows teacher name, dates, status. 4. Verify can edit or delete each subscription.</steps>
      </test>
      <test id="AC4">
        <description>Test subscription update</description>
        <steps>1. Edit subscription dates. 2. Verify changes saved. 3. Verify subscription status updates. 4. Verify teacher access updated accordingly.</steps>
      </test>
    </ideas>
  </tests>
</story-context>

