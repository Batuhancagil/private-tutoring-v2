<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5-6</storyId>
    <title>Low Accuracy Alerts</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-6-low-accuracy-alerts.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system</asA>
    <iWant>to generate low accuracy alerts</iWant>
    <soThat>teachers are notified when students struggle</soThat>
    <tasks>
      <task>Add AccuracyAlert model to prisma/schema.prisma</task>
      <task>Create migration for AccuracyAlert model</task>
      <task>Create alert service (lib/alert-service.ts) with checkAndGenerateAlert() function</task>
      <task>Integrate alert generation with calculateTopicProgress() in lib/progress-calculator.ts</task>
      <task>Create alerts API endpoint (GET /api/teacher/alerts)</task>
      <task>Create alert resolution API endpoint (POST /api/teacher/alerts/:alertId/resolve)</task>
      <task>Create AlertList component for displaying alerts</task>
      <task>Implement auto-resolution when accuracy improves above threshold</task>
      <task>Unit tests for alert service functions</task>
      <task>Integration tests for API endpoints and alert generation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <given>a student's accuracy falls below threshold</given>
      <when>progress is calculated</when>
      <then>a low accuracy alert is generated</then>
      <and>alert is visible to teacher</and>
      <and>alert is visible to parent</and>
      <and>threshold is customizable (default 70%)</and>
    </criterion>
    <criterion id="AC2">
      <given>a student's topic accuracy falls below threshold</given>
      <when>topic progress is calculated</when>
      <then>an alert is generated for that topic</then>
      <and>alert includes student name, topic name, and current accuracy</and>
      <and>alert includes threshold value</and>
      <and>alert timestamp is recorded</and>
    </criterion>
    <criterion id="AC3">
      <given>a student's accuracy improves above threshold</given>
      <when>progress is recalculated</when>
      <then>existing alert is marked as resolved</then>
      <and>alert is no longer shown as active</and>
      <and>resolution timestamp is recorded</and>
    </criterion>
    <criterion id="AC4">
      <given>multiple alerts exist for a student</given>
      <when>alerts are retrieved</when>
      <then>only unresolved alerts are returned by default</then>
      <and>resolved alerts can be optionally retrieved</and>
      <and>alerts are sorted by most recent first</and>
    </criterion>
    <criterion id="AC5">
      <given>an alert is generated</given>
      <when>alert is stored</when>
      <then>alert is associated with student, topic (if applicable), and teacher</then>
      <and>tenant isolation is enforced (teachers only see their students' alerts)</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/stories/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>Low Accuracy Alerts</section>
        <snippet>Generate alerts when student accuracy falls below customizable threshold (default 70%) visible to teachers and parents. Alert model stores student, topic, accuracy, threshold, and resolution status.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 5: Progress Calculation &amp; Visualization - Story 5.6</section>
        <snippet>As a system, I want to generate low accuracy alerts, So that teachers are notified when students struggle. Alert generation logic, threshold checking, alert storage, alert display components.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-006: Progress Calculation &amp; Visualization</section>
        <snippet>FR-006.7: The system shall generate low accuracy alerts when student accuracy falls below threshold. Alerts visible to teachers and parents.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Data Architecture</section>
        <snippet>Database models use Prisma schema. Add AccuracyAlert model with relations to User (student), Topic, and Lesson. Enforce tenant isolation via teacherId.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>database schema</kind>
        <symbol>User, Topic, Lesson</symbol>
        <lines>20-82</lines>
        <reason>Existing models to reference. AccuracyAlert model will have relations to User (student), Topic (optional), and Lesson (optional).</reason>
      </artifact>
      <artifact>
        <path>lib/progress-calculator.ts</path>
        <kind>service</kind>
        <symbol>calculateTopicProgress</symbol>
        <lines>1-200</lines>
        <reason>Progress calculation service. Need to integrate alert generation after calculating topic accuracy. Call checkAndGenerateAlert() after accuracy calculation.</reason>
      </artifact>
      <artifact>
        <path>app/api/teacher/progress/topic/[topicId]/route.ts</path>
        <kind>API route</kind>
        <symbol>GETHandler</symbol>
        <lines>1-100</lines>
        <reason>Example API pattern to follow: uses withRole() helper, Zod validation, error logging, performance tracking.</reason>
      </artifact>
      <artifact>
        <path>lib/api-helpers.ts</path>
        <kind>utility</kind>
        <symbol>withRole, logApiError, trackPerformance</symbol>
        <lines>1-200</lines>
        <reason>API helper functions for role-based authorization, error logging, and performance tracking. Use these in new API endpoints.</reason>
      </artifact>
      <artifact>
        <path>components/teacher/StudentList.tsx</path>
        <kind>component</kind>
        <symbol>StudentList</symbol>
        <lines>1-100</lines>
        <reason>Example component pattern to follow. AlertList component will follow similar patterns for displaying lists.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="next" version="^14.2.0" />
        <package name="react" version="^18.3.0" />
        <package name="react-dom" version="^18.3.0" />
        <package name="@prisma/client" version="^5.19.0" />
        <package name="prisma" version="^5.19.0" />
        <package name="zod" version="^3.23.8" />
        <package name="typescript" version="^5.5.0" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Multi-tenant isolation: All alerts must respect teacherId isolation - teachers can only see alerts for their own students</constraint>
    <constraint>API authorization: Use withRole('TEACHER') helper to ensure only teachers can access alerts</constraint>
    <constraint>Alert generation: Alerts generated automatically when progress calculated and accuracy &lt; threshold</constraint>
    <constraint>Threshold configuration: Default 70% for MVP, customization UI deferred to Epic 6</constraint>
    <constraint>Alert visibility: Alerts visible to teachers (Epic 6) and parents (Epic 7)</constraint>
    <constraint>Database model: AccuracyAlert model stores student, topic, accuracy, threshold, and resolution status</constraint>
    <constraint>Auto-resolution: Alerts auto-resolved when accuracy improves above threshold</constraint>
    <constraint>Error handling: Alert generation errors should not fail progress calculation (graceful degradation)</constraint>
    <constraint>Database optimization: Use indexed queries on AccuracyAlert.studentId, topicId, resolved for efficient retrieval</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/teacher/alerts</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/teacher/alerts?studentId=string&amp;resolved=boolean
Response (200): {
  alerts: [
    {
      id: string,
      studentId: string,
      studentName: string,
      topicId: string,
      topicName: string,
      accuracy: number,
      threshold: number,
      createdAt: Date
    }
  ]
}
Response (403): { error: "Access denied" }</signature>
      <path>app/api/teacher/alerts/route.ts</path>
    </interface>
    <interface>
      <name>POST /api/teacher/alerts/:alertId/resolve</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/teacher/alerts/:alertId/resolve
Response (200): { success: boolean, data: AccuracyAlert }
Response (404): { error: "Alert not found" }
Response (403): { error: "Access denied" }</signature>
      <path>app/api/teacher/alerts/[alertId]/resolve/route.ts</path>
    </interface>
    <interface>
      <name>checkAndGenerateAlert()</name>
      <kind>function</kind>
      <signature>async function checkAndGenerateAlert(studentId: string, topicId: string, accuracy: number, threshold: number): Promise&lt;AccuracyAlert | null&gt;
Input: studentId, topicId, accuracy, threshold
Output: AccuracyAlert if created, null if not needed
Checks if accuracy &lt; threshold and creates alert if needed. Auto-resolves existing alerts if accuracy ≥ threshold.</signature>
      <path>lib/alert-service.ts</path>
    </interface>
    <interface>
      <name>AccuracyAlert Model (Prisma)</name>
      <kind>Database model</kind>
      <signature>model AccuracyAlert {
  id: String @id @default(cuid())
  studentId: String
  topicId: String?
  lessonId: String?
  accuracy: Float
  threshold: Float
  createdAt: DateTime @default(now())
  resolved: Boolean @default(false)
  resolvedAt: DateTime?
  student: User @relation(...)
  topic: Topic? @relation(...)
  lesson: Lesson? @relation(...)
  @@index([studentId])
  @@index([topicId])
  @@index([resolved])
}</signature>
      <path>prisma/schema.prisma</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing approach: Unit tests for alert generation logic, integration tests for API endpoints and alert triggers.
      Focus on alert generation correctness, threshold checking, auto-resolution, and tenant isolation.
      Test edge cases: accuracy exactly at threshold, accuracy just below threshold, duplicate alerts, auto-resolution.
      Manual testing for API endpoints via browser dev tools or Postman.
    </standards>
    <locations>
      Unit tests: Create test file for lib/alert-service.ts (e.g., lib/__tests__/alert-service.test.ts)
      Integration tests: Test API endpoints via browser dev tools Network tab or Postman
      No formal test framework currently configured - focus on manual testing and code review
    </locations>
    <ideas>
      <test id="AC1">
        <description>Test alert generation</description>
        <steps>1. Call checkAndGenerateAlert() with accuracy 65% &lt; threshold 70%. 2. Verify alert is created. 3. Verify alert includes student, topic, accuracy, threshold. 4. Verify alert timestamp is recorded.</steps>
      </test>
      <test id="AC1">
        <description>Test no alert when accuracy ≥ threshold</description>
        <steps>1. Call checkAndGenerateAlert() with accuracy 75% ≥ threshold 70%. 2. Verify no alert is created. 3. Verify function returns null.</steps>
      </test>
      <test id="AC2">
        <description>Test alert includes required fields</description>
        <steps>1. Generate alert for student with topic. 2. Verify alert includes student name, topic name, current accuracy. 3. Verify alert includes threshold value. 4. Verify alert timestamp is recorded.</steps>
      </test>
      <test id="AC3">
        <description>Test auto-resolution</description>
        <steps>1. Create alert with accuracy 65% &lt; threshold 70%. 2. Call checkAndGenerateAlert() with accuracy 75% ≥ threshold. 3. Verify existing alert is marked as resolved. 4. Verify resolvedAt timestamp is recorded.</steps>
      </test>
      <test id="AC4">
        <description>Test alerts API endpoint</description>
        <steps>1. Call GET /api/teacher/alerts. 2. Verify returns only unresolved alerts by default. 3. Verify alerts sorted by most recent first. 4. Test resolved filter works.</steps>
      </test>
      <test id="AC5">
        <description>Test tenant isolation</description>
        <steps>1. Call GET /api/teacher/alerts with student from different teacher. 2. Verify API returns only alerts for current teacher's students. 3. Verify tenant isolation is enforced.</steps>
      </test>
    </ideas>
  </tests>
</story-context>

